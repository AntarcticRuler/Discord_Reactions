<!DOCTYPE html>

<head>
    <link rel="stylesheet" href="https://dhbhdrzi4tiry.cloudfront.net/cdn/sites/foundation.min.css">
</head>

<body> 

  <div id="servers">
    
  </div>

  <div id=serverInfo>
  
  </div>

</body>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://dhbhdrzi4tiry.cloudfront.net/cdn/sites/foundation.js"></script>
<script>
    $(document).foundation();

    // var code = localStorage.getItem('key');

    // if (!window.location.href.split('code=')[1] && (code == undefined || code == 'undefined'))
    //   window.location.href = "./rxns/auth";
    // else 
    //   localStorage.setItem('key', window.location.href.split('code=')[1]);

    // code = localStorage.getItem('key');
    // console.log (code);

    var serverID; // The ID of the currently clicked server

    // Adds all the user's servers to the screen to choose from
    var data = $.get( "./rxns/data", function( data ) { 

      let servers = document.getElementById("servers");

      data.forEach(element => {
        let server = document.createElement('div')
        server.innerHTML = element.name;
        server.onclick = function () { clickServer(element) };
        servers.appendChild(server);
        console.log (element)
      });

    });

    // Runs when a server is clicked on
    function clickServer (element) {

      serverID = element.id;
      
      $.get( "./rxns/server_reactions", function( server_data ) { 

        let existing = false;
        
        // Checks to see if the server being clicked is on the list of added servers
        server_data.forEach(curr_server => {
          if (curr_server.id == serverID)
            existing = true;
        })

        console.log (server_data);

        var info = document.getElementById('serverInfo');

        // Adds the info about the server
        if (existing) {
          info.innerHTML = `<h3>${element.name}</h3> <img src="https://cdn.discordapp.com/icons/${element.id}/${element.icon}"> 
                          <br><br> 
                          <input type="text" id="url" name="url" placeholder="Reaction">
                          <br>
                          <input type="text" id="name" name="name" placeholder="Reaction Name">
                          <input type="submit" value="Submit" onclick=submit()>
                          <br><br>
                          <h5>Current Reactions:</h5>` 
          // Loops through all current servers to find the current one
          server_data.forEach(curr_server => {
            if (curr_server.id == serverID)
              // Loops through and displays all reactions
              Object.entries (curr_server.reactions).forEach ( reaction => {
                console.log (reaction);
                info.innerHTML += `<p>${reaction[0]} : ${reaction[1]}</p><br>`
              } )
          })
        }
        else 
          info.innerHTML = `<h3>${element.name}</h3> <img src="https://cdn.discordapp.com/icons/${element.id}/${element.icon}"><br><br><h4><a href="https://discordapp.com/oauth2/authorize?client_id=688388524528893955&scope=bot&permissions=67488832" target="blank">Add RXNS to your server!</a><h4>`

        console.log (`${element.name} clicked!`);

      });
    }

    // Submits the data to the backend server
    // Will add the reaction posted on the website
    function submit () {
      console.log ("ATTEMPTING TO SUBMIT");
      let url = document.getElementById('url').value
      let name = document.getElementById('name').value
      let data = { server: serverID, url: url, name: name }
      console.log (data);
      $.ajax({
        url: "/rxns/add",
        type: "POST",
        dataType: "json",
        contentType : "application/json",
        data: JSON.stringify(data),
        success: function(data){
          console.log (data)
        }
      });
    }
</script>