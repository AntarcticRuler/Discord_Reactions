<!DOCTYPE html>

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/css/foundation.min.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/js/foundation.min.js"></script>
    <link rel="stylesheet" href="./rxns.css">

    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body> 

  <div class="top-bar show-for-landscape" style="min-height: 10%; top: 1%; background-color: transparent;">
    <div class="row">
      <div class="columns top-bar-left" style="min-width: 350px; max-width: 25%; margin-right: auto;">
        <a href="/">
          <img src="./assets/NickStudiosLogoLight.png" style="display: block; width: auto; height: auto; max-height: 72px; min-width: 350px; max-width: 25%; margin-top: auto;">
        </a>
      </div>
      <div class="top-bar-right" style="max-width: calc(64px + 1%); margin-left: auto;">
          <img id="user_image" style="width: 64px; height: 64px; border-radius: 36px; display: block;">
      </div>
    </div>
  </div>
  <div class="columns top-bar show-for-portrait" style="width: auto; height: auto; min-height: 11.5%; background-color: transparent;">
    <a href="/">
      <img src="./assets/NickStudiosLogoLight.png" style="display: block; width: auto; height: auto; margin: auto; max-width: 90%; max-height: 90%;">
    </a>
  </div>

  <div class="row"> 
    <h3 class="text-center"> <u> Your Servers </u> </h3>
  </div>
  <div id="servers" class="row align-center">
    
  </div>

  <div id=serverInfo>

  </div>

</body>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://dhbhdrzi4tiry.cloudfront.net/cdn/sites/foundation.js"></script>
<script>
    $(document).foundation();

    // var code = localStorage.getItem('key');

    // if (!window.location.href.split('code=')[1] && (code == undefined || code == 'undefined'))
    //   window.location.href = "./rxns/auth";
    // else 
    //   localStorage.setItem('key', window.location.href.split('code=')[1]);

    // code = localStorage.getItem('key');
    // console.log (code);

    var serverID; // The ID of the currently clicked server
    var clicked_server;

    var token = window.location.href.split('token=')[1];

    // Checks to see if the user is logged in
    if (!token)
      document.getElementById("servers").innerHTML = `<h5 class=text-center>
          <a href="/rxns/auth">You are not currently logged in! To log in, click here to authenticate yourself.</a>
        </h5>`
    else
      // Adds all the user's servers to the screen to choose from
      var data = $.get( `./rxns/${token}/data`, function( data ) { 

        console.log (data);

        let servers = document.getElementById("servers");

        let count = 0;

        data.forEach( () => { count++ })

        data.forEach(element => {
          let server = document.createElement('h5')
          server.innerHTML = element.name;
          server.onclick = function () { clickServer(element) };
          server.classList.add ('columns');
          server.classList.add ('text-center');
          server.classList.add ('pointer');
          server.style.maxWidth = `${100/count}%`
          servers.appendChild(server);
        });

        postUser();

      });

    function postUser () {
      console.log ('uwu');
      var user_data = $.get( `./rxns/${token}/user`, function( u_data ) { 
        document.getElementById("user_image").src = `https://cdn.discordapp.com/avatars/${u_data.id}/${u_data.avatar}.png?size=512`;
      });
    }

    // Runs when a server is clicked on
    function clickServer (element) {

      serverID = element.id;
      clicked_server = element;
      
      $.get( "./rxns/server_reactions", function( server_data ) { 

        let existing = false;
        
        // Checks to see if the server being clicked is on the list of added servers
        server_data.forEach(curr_server => {
          if (curr_server.id == serverID)
            existing = true;
        })

        console.log (server_data);

        var info = document.getElementById('serverInfo');

        // Adds the info about the server
        if (existing) {
          info.innerHTML = `<h3 class="text-center">${element.name}</h3> <img  style="display:block;margin:auto;"" src="https://cdn.discordapp.com/icons/${element.id}/${element.icon}"> 
                          <br>
                          <input style="margin:auto" class="text-center" type="text" id="name" name="name" placeholder="Reaction Name">
                          <br>
                          <input style="margin:auto" class="text-center" type="text" id="url" name="url" placeholder="Reaction">
                          <br>
                          <input style="display:block; margin:auto" class="text-center" type="submit" value="Submit" onclick=submit()>
                          <br><br>
                          <div class="row">
                            <h5 class="columns small-3">Current Reactions:</h5> 
                            <div class="columns small-9">
                              <div class="row">
                                ${getCurrReactions(server_data)}
                              </div>
                            </div>
                          </div>`
        }
        else 
          info.innerHTML = `<h3 class="text-center">${element.name}</h3> <img  style="display:block;margin:auto;"" src="https://cdn.discordapp.com/icons/${element.id}/${element.icon}">
          <br>
          <h4 class="text-center"><a href="https://discordapp.com/oauth2/authorize?client_id=688388524528893955&scope=bot&permissions=67488832" target="blank">
            Add RXNS to your server!
          </a><h4>`

        console.log (`${element.name} clicked!`);

      });
    }

    function getCurrReactions (server_data) {
      let string = ``;
      let count = 0;
      // Loops through all current servers to find the current one
      server_data.forEach(curr_server => {
        if (curr_server.id == serverID) {
          let reactions = Object.entries (curr_server.reactions);
          reactions.forEach( () => { count++ }) // Gets a count of all the reactions for width purposes
          // Loops through and displays all reactions
          reactions.forEach ( reaction => {
            console.log (reaction);
            string += `<div class="columns small-12 medium-6 large-4"> <div class="row"> <p class="columns small-10">${shortenReactionName(reaction[0])} <strong>:</strong> ${shortenReactionName(reaction[1])}</p><p class="columns small-2 delete" onclick="deleteReaction('${reaction[0]}')">X</p> </div> </div>`
          } )
          string += `</div> </div>`
        }
      })
      return string;
    }

    function deleteReaction (name) {
      console.log ("ATTEMPTING TO DELETE");
      let data = { server: serverID, name: name}
      console.log (data);
      $.ajax({
        url: `/rxns/${token}/delete`,
        type: "POST",
        dataType: "json",
        contentType : "application/json",
        data: JSON.stringify(data),
        success: function(data){
          console.log (data)
        }
      });
      refresh();
    }

    // Shortens the name of the reaction
    function shortenReactionName (reaction) {
      reaction = reaction.split ("'").join("");
      if (reaction.split ('https://')[1])
        reaction = reaction.split ('https://')[1]
      if (reaction.length > 19)
        return `${reaction.substr(0, 19)}...`;
      return reaction;
    }

    // Submits the data to the backend server
    // Will add the reaction posted on the website
    function submit () {
      console.log ("ATTEMPTING TO SUBMIT");
      let url = document.getElementById('url').value
      let name = document.getElementById('name').value.toLowerCase();
      let data = { server: serverID, url: url, name: name }
      console.log (data);
      $.ajax({
        url: `/rxns/${token}/add`,
        type: "POST",
        dataType: "json",
        contentType : "application/json",
        data: JSON.stringify(data),
        success: function(data){
          console.log (data)
        }
      });
      refresh();
    }

    // Refreshes the page
    function refresh () {
      console.log ("REFRESHING");
      setTimeout(() => {
        clickServer(clicked_server);
      }, 225);
    }

</script>